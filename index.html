<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html lang="en">
<head>
	<meta equiv="Content-type" content="text/html; charset=utf8" />
	
	<script type="text/javascript" src="js/jquery-1.3.2.min.js"></script>
	<script type="text/javascript" src="js/jquery-ui-1.7.2.custom.min.js"></script>
	<script type="text/javascript" src="js/jquery.flydom-3.1.1.js"></script>
	<link type="text/css" href="css/ui-lightness/jquery-ui-1.7.2.custom.css" rel="Stylesheet" />
	
	<link type="text/css" href="css/database-diagram-0.1.css" rel="Stylesheet" />

	<script type="text/javascript">
	
var sqlparser = {

	parse: function(sql){

		var db = new database();
		db.parse(sql);
		return db;
	},
};

function database() {
	this.name = '';
	this.tables = [];
	
	this.parse = function(sql){
		
		this.name = this.get_db_name(sql);
		
		// split the SQL into the table definitions:
		// NOTE: the g asks for all matches
		var pattern = /CREATE TABLE([^;]*?);/g
		var match;
		while (match = pattern.exec(sql)) {
		
			var t = new table();
			t.parse(match[1]);
			this.tables[t.name] = t;
		}
		
		//
		// MySQL: MyISAM foreign keys use pattern matching
		//
		var t_names = this.get_table_names();
		for(var t in this.tables)
			this.tables[t].find_foreign_key(this.tables);
		
		//
		// MySQL: INNODB FKs look up the FK definition
		//
		for(var t in this.tables)
			this.tables[t].find_fks();
		
	}
	
	this.get_table_names = function(){
	
		var table_names = new Array();
		for(var name in this.tables)
			table_names.push(name);
		
		return table_names;
	}
	
	this.get_db_name = function(sql){
	
		var myregexp = /CREATE TABLE `([^`]*)`/;
		var match = myregexp.exec(sql);
		if (match != null && match.length > 1)
			return match[1];
		else
			return '';
	}
};

function table() {

	this.name = '';
	this.width = 0;
	this.height = 60;
	this.columns = Array();
	this.internals = [];
	
	this.parse = function(sql) {
		this.name = this.get_name(sql);
		this.internals = this.get_internals(sql);
		this.columns = this.parse_columns(this.internals);
	}
	
	this.find_foreign_key = function(tables) {
		for(var i in this.columns)
			this.columns[i].find_foreign_key(tables);
	}
	
	this.get_name = function(sql){
		// look for `table_name`
		var matches = sql.match(/[^`]*`([^`]*)`/);
		return matches[1];
	}
	
	this.get_internals = function(sql){
	
		// get everything between the brackets
		//   `table_name` ( **columns + other stuff** ) ENGINE=...
		//
		// fucking dot does NOT match newlines, so this regex
		// hacks around that: (?:.|[\n\r])  get . or \n or \r
		//
		var matches = sql.match(/` \(((?:.|[\n\r])*)\) ENGINE/);
		var inner_sql = matches[1];
		
		// now split on the new line this seperates the table
		// definitions. COMMENTs may have commas in, but not newlines
		return inner_sql.split("\n");
	}
	
	this.parse_columns = function(parts){
	
		var columns = Array();
		
		//
		// Which SQL definitions contain column info,
		// match: space, space, backtick, column name, backtick. E.g:
		//   `column_name`
		// but skips the PRIMARY KEY etc.
		//
		var pattern = /  `[^`]*` /;
		for(var i=0; i<parts.length; i++){
			var matches = parts[i].match(pattern);
			if(matches)
			{
				var c = new column();
				c.parse(parts[i]);
				columns[c.name] = c;
			}
		}
		return columns;
	}
	
	this.find_fks = function(){

		//
		// MySQL InnoDB FK. Look for this:
		//   CONSTRAINT `FK_clients` FOREIGN KEY (`manager_id`) REFERENCES `staff` (`id`)
		// we want the text manager_id and staff
		//
		var pattern = /FOREIGN KEY \(`([^`]*)`\) REFERENCES `([^`]*)`/;
		for(var i=0; i<this.internals.length; i++){
			var matches = this.internals[i].match(pattern);
			if(matches)
			{
				var from_column = matches[1];
				var to_table = matches[2];
				var col = this.columns[from_column];
				col.links_to(to_table);
			}
		}
	}
};

function column() {
	this.name = '';
	this.sql = '';
	this.foreign_key = false;
	
	this.parse = function (sql){
		//
		// match some whitespace then a `
		// matches:
		//   `column_name`
		//
		var pattern = /[\s]`([^`]*)/;
		var matches = sql.match(pattern);
		if(matches)
			this.name = matches[1];
			
		this.sql = sql;
	}
	
	this.links_to = function(table_name) {
		this.foreign_key = table_name;
	}
	
	this.find_foreign_key = function(tables) {
	
		var tmp = this.find_foreign_key_in_comment();
		if(tmp!=null)
		{
			this.foreign_key = tmp;
			return;
		}
		
		// MySQL MyISAM (no proper FK) just use pattern matching
		// on the column names
		var attributes = {};
		var regexps = new Array(
			// LOOK FOR fk_table_name
			/fk_([a-zA-Z0-9_]*)/,
			// LOOK FOR table_name_fk
			/([a-zA-Z0-9_]*)_fk/
			);
	
		for(var i in regexps)
		{
			var myregexp = regexps[i];
			var match = myregexp.exec(this.name);
			// is this column is a foreign key
			if(match != null && match.length > 1)
			{
				
				var tmp = this.find_table(tables, match[1]);
				if(tmp.found)
					this.foreign_key = tmp.name;
			
				// fk_project links to table projects
				var tmp = this.find_table(tables, match[1]+'s');
				if(tmp.found)
					this.foreign_key = tmp.name;
				
			}
		}
	}
	
	this.find_foreign_key_in_comment = function()
	{
		//
		// we look in the column comments to see if this
		// column is really a FK pointing somewhere
		//
		// This regex grabs everything in the comments:
		//   `fk_project_manager` int(11) default NULL COMMENT 'john o''pegg '' woo''oo dbd:fk-to:staff',
		//
		var myregexp = /COMMENT '([^']*(?:''[^']*)*)'/;
		var match = myregexp.exec(this.sql);
		if (match != null && match.length > 1) {
			
			// now look for dbd:fk-to:<table name>
			var myregexp = /dbd:fk-to:([^' ]*)/;
			var match = myregexp.exec(match[1]);
			if (match != null && match.length > 1) {
				// return the table this column points at
				return match[1];
			}
		}
		
		return null;
	}
	
	this.find_table = function(tables, name)
	{
		for(var i in tables)
		{
			if(tables[i].name == name)
				return {found: true, name: tables[i].name};
		}
		
		return {found: false};
	}
};

</script>	
<script type="text/javascript">

	// degrees to radians, because most people think in degrees
    function degToRad(angle_degrees)
    {
       return angle_degrees/180*Math.PI;
    }

	// draw the head of an arrow (not the main line)
	//  ctx: canvas context
	//  x,y: coords of arrow point
	//  angle_from_north_clockwise: angle of the line of the arrow from horizontal
	//  upside: true=above the horizontal, false=below
	//  barb_angle: angle between barb and line of the arrow
	//  filled: fill the triangle? (true or false)
	function drawArrowHead(ctx, x, y, angle_from_horizontal_degrees, upside, //mandatory
							barb_length, barb_angle_degrees, filled)          //optional
	{
		if(barb_length==undefined) { barb_length=13; }
		if(barb_angle_degrees==undefined) { barb_angle_degrees = 20; }
		if(filled==undefined) { filled=true; }
		if(upside) { alpha = -angle_from_horizontal_degrees; }
		else { alpha = angle_from_horizontal_degrees; }

		//first point is end of one barb
		a = x + (barb_length * Math.cos(degToRad(alpha - barb_angle_degrees)));
		b = y + (barb_length * Math.sin(degToRad(alpha - barb_angle_degrees)));

		//final point is end of the second barb
		c = x + (barb_length * Math.cos(degToRad(alpha + barb_angle_degrees)));
		d = y + (barb_length * Math.sin(degToRad(alpha + barb_angle_degrees)));
		

		ctx.beginPath();
		ctx.moveTo(a,b);
		ctx.lineTo(x,y);
		ctx.lineTo(c,d);
		if(filled) { ctx.fill(); }
		else { ctx.stroke(); }
		return true;
	}

	function drawArrow(ctx, x, y, x2, y2)
	{
		ctx.beginPath();
		ctx.moveTo(x, y);
		ctx.lineTo(x2, y2);
		ctx.stroke();
		ctx.closePath();
		//soh cah toa
		var angle = Math.atan2(x - x2, y - y2);
		drawArrowHead(ctx, x2, y2, (angle*180/Math.PI)-90, true);
	}
	
	function distance(a, b, x, y)
	{
		var dx = a-x;
		var dy = b-y;
		return Math.sqrt( dx * dx + dy * dy );
	}
	
	function joinItems(ctx, from_left, from_right, from_y, to_left, to_right, to_y)
	{
		var left_left =		distance(from_left, from_y, to_left, to_y);
		var left_right =	distance(from_left, from_y, to_right, to_y);
		var right_left =	distance(from_right, from_y, to_left, to_y);
		var right_right =	distance(from_right, from_y, to_right, to_y);
		var min = Math.min(left_left, left_right, right_left, right_right);
		
		if( left_left == min)
			drawArrow(ctx, from_left, from_y, to_left, to_y);
		
		if( left_right == min)
			drawArrow(ctx, from_left, from_y, to_right, to_y);

		if( right_left == min)
			drawArrow(ctx, from_right, from_y, to_left, to_y);
			
		if( right_right == min)
			drawArrow(ctx, from_right, from_y, to_right, to_y);
	}
	
	function updateCanvas(canvasJq, tables)
	{
		var canvasEl = canvasJq[0];
		canvasEl.width=canvasJq.width();
		canvasEl.height=canvasJq.height();
		var cOffset = canvasJq.offset();
		var ctx = canvasEl.getContext("2d");
		ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
		
		$(tables).each(function(){
			$("li", this).each(function(){
				var li=$(this);
				if(li.attr("rel"))
				{
					var srcOffset=li.offset();
					var srcMidHeight=li.height()/2;
					var targetLi=$("#"+li.attr("rel"));
					if(targetLi.length)
					{
						var trgOffset=targetLi.offset();
						var trgMidHeight=li.height()/2;
						
						joinItems(ctx,
							srcOffset.left - cOffset.left,
							srcOffset.left - cOffset.left + li.outerWidth(),
							srcOffset.top - cOffset.top + srcMidHeight,
							trgOffset.left - cOffset.left,
							trgOffset.left - cOffset.left + targetLi.outerWidth(),
							trgOffset.top - cOffset.top + trgMidHeight );
					}
				}
			});
		});
		
	}
	
	$(document).ready(function(){
	
	});


Storage.prototype.setObject = function(key, value) {
    this.setItem(key, JSON.stringify(value));
}

Storage.prototype.getObject = function(key) {
    return JSON.parse(this.getItem(key));
}

function save_position(obj)
{
	var db = 'databaseName'
	var name = obj.id;
	var pos = $(obj).position();
	var storage = window['localStorage'];
	storage.setObject(db+'-'+name, pos);

	var p2 = localStorage.getObject(db+'-'+name);
	var x =1;
}

function load_position(obj)
{
	var db = 'databaseName'
	var name = obj.id;
	var storage = window['localStorage'];

	return storage.getObject(db+'-'+name);
}

// tables is a jQuery collection of DIVs
function load_positions(tables)
{
	$(tables).each(function(){
		var pos = load_position(this);
		if(pos!=null)
		{
			$(this).css({
				left: pos.left+"px",
				top: pos.top+"px"
				});
		}
	});
}

function go_inno()
{
	dbd($("#InnoDB").val());
}

function go()
{
	dbd($("#sql").val());
}

function dbd(sql)
{
	var db = sqlparser.parse(sql);
	
	/**
	
	We are attemping to build something like this, but programatically:
	
		$("body").createPrepend(
			'div',
			{'class':'blk ui-widget-content', 'id':'clients'},
			[
				'h1', {'class':'ui-widget-header'}, 'Clients',
				'ul', {}, [
					'li', {'class':'key'}, 'id',
					'li', {}, 'name',
					'li', {}, 'contact_details',
					]
			]);
	
	**/
	
	
	for(var t in db.tables)
	{
		// set the DIV id to be the table name, so other tables can link to it
		// ui-widget-content is for jQuery UI
		var div_attributes = {'class':'blk ui-widget-content', 'id':db.tables[t].name};
		
		var list_items = new Array();
		for(var i in db.tables[t].columns)
		{
			var column = db.tables[t].columns[i];
			list_items.push('li');
			
			if(column.foreign_key)
				list_items.push({'rel': column.foreign_key});
			else
				list_items.push({});
			
			list_items.push(column.name);
		}
		
		$("body").createPrepend(
			'div', div_attributes,
			[
				// ui-widget-header is for jQuery UI
				'h1', {'class':'ui-widget-header'}, db.tables[t].name,
				'ul', {}, list_items
			]);
	}
	
	load_positions($(".blk"));
	updateCanvas($("#canvas"), $(".blk"));
	
	// jQuery make all the tables draggable
	$(".blk").draggable({
		handle: 'h1',
		stop: function() {
			updateCanvas($("#canvas"), $(".blk"));
			save_position(this);
			}
		});
			
}

</script>
</head>
<body>


<canvas id="canvas"></canvas>
<div style="padding-top: 640px;">

<input type="button" onclick="go()" value="moo">

<textarea id="sql">
CREATE DATABASE /*!32312 IF NOT EXISTS*/`projects` /*!40100 DEFAULT CHARACTER SET latin1 */;

USE `projects`;

CREATE TABLE `test` (
  `id` int(11) NOT NULL auto_increment,
  `fk_article` varchar(64) default NULL,
  PRIMARY KEY  (`id`)
) ENGINE=MyISAM AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

CREATE TABLE `article_payment` (
  `id` int(11) NOT NULL auto_increment,
  `text` varchar(64) default NULL,
  PRIMARY KEY  (`id`)
) ENGINE=MyISAM AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

/*Table structure for table `article_status` */

DROP TABLE IF EXISTS `article_status`;

CREATE TABLE `article_status` (
  `id` int(11) NOT NULL auto_increment,
  `status` varchar(64) default NULL,
  `order` int(11) default NULL,
  `class` varchar(8) default NULL,
  PRIMARY KEY  (`id`)
) ENGINE=MyISAM AUTO_INCREMENT=7 DEFAULT CHARSET=latin1;

/*Table structure for table `articles` */

DROP TABLE IF EXISTS `articles`;

CREATE TABLE `articles` (
  `id` int(11) NOT NULL auto_increment,
  `name` varchar(256) default NULL,
  `keyphrase` varchar(256) character set utf8 collate utf8_bin default NULL,
  `cost` float default NULL,
  `deadline` date default NULL,
  `fk_article_payment` int(11) default NULL,
  `fk_status` int(11) default NULL,
  `fk_article_status` int(11) default NULL,
  `project_fk` int(11) default NULL,
  `fk_staff` int(11) default NULL,
  PRIMARY KEY  (`id`)
) ENGINE=MyISAM AUTO_INCREMENT=1491 DEFAULT CHARSET=latin1;

CREATE TABLE `projects` (
  `id` int(11) NOT NULL auto_increment,
  `name` varchar(64) default NULL,
  `fk_sales` int(11) default NULL COMMENT 'This is the sales manager, dbd:fk-to:staff',
  `fk_project_manager` int(11) default NULL COMMENT 'xxx dbd:fk-to:staff xxx',
  PRIMARY KEY  (`id`)
) ENGINE=MyISAM AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

/*Table structure for table `projects` */

DROP TABLE IF EXISTS `projects`;

CREATE TABLE `staff` (
  `id` int(11) NOT NULL auto_increment,
  `name` varchar(200) default NULL,
  PRIMARY KEY  (`id`)
) ENGINE=MyISAM AUTO_INCREMENT=939 DEFAULT CHARSET=latin1;

</textarea>

<input type="button" onclick="go_inno()" value="InnoDB">

<textarea id="InnoDB">
/*
SQLyog Enterprise - MySQL GUI v8.05 
MySQL - 5.0.45-community : Database - zz
*********************************************************************
*/


/*!40101 SET NAMES utf8 */;

/*!40101 SET SQL_MODE=''*/;

/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;

CREATE DATABASE /*!32312 IF NOT EXISTS*/`zz` /*!40100 DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci */;

USE `zz`;

/*Table structure for table `clients` */

DROP TABLE IF EXISTS `clients`;

CREATE TABLE `clients` (
  `id` int(11) NOT NULL auto_increment,
  `coool` int(11) default NULL,
  `q` int(11) default NULL,
  `r` int(11) default NULL,
  `manager_id` int(11) default NULL,
  PRIMARY KEY  (`id`),
  KEY `FK_clients` (`manager_id`),
  CONSTRAINT `FK_clients` FOREIGN KEY (`manager_id`) REFERENCES `staff` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci CHECKSUM=1 DELAY_KEY_WRITE=1 ROW_FORMAT=DYNAMIC COMMENT='comments zooom';

/*Table structure for table `orders` */

DROP TABLE IF EXISTS `orders`;

CREATE TABLE `orders` (
  `id` int(11) NOT NULL auto_increment,
  `fk_client` int(11) default NULL,
  PRIMARY KEY  (`id`),
  KEY `FK_orders` (`fk_client`),
  CONSTRAINT `FK_orders` FOREIGN KEY (`fk_client`) REFERENCES `clients` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci CHECKSUM=1 DELAY_KEY_WRITE=1 ROW_FORMAT=DYNAMIC COMMENT='comment woop woop';

/*Table structure for table `staff` */

DROP TABLE IF EXISTS `staff`;

CREATE TABLE `staff` (
  `id` int(11) NOT NULL,
  `name` varchar(123) collate utf8_unicode_ci default NULL,
  PRIMARY KEY  (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;

/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;

</textarea>

<br>	
http://dohpaz.com/flydom/
<br>
http://stackoverflow.com/questions/1104295/jquery-use-canvas-to-draw-lines-between-divs
<br>
http://www.things.org.uk/examples/arrowtest.html
<br>
http://thejit.org/
<br>
http://hacks.mozilla.org/2009/06/localstorage/
<br>
http://www.mysqlperformanceblog.com/2007/01/08/innodb-vs-myisam-vs-falcon-benchmarks-part-1/
<br>
https://svn.apache.org/repos/asf/incubator/olio/webapp/java/trunk/etc/schema.sql
<h2>How to use it:</h2>
<p>
<ul>
<li>Find your database and export as SQL dump. Structure only.
<li>Paste this SQL into the box
<li>Click go! (this may take a while)
</ul>
</p>

<h2>More control:</h2>
<p>
<ul>
<li>Find your database and export as SQL dump. Structure only.
<li>Trim the SQL to only show tables you are interested in.
<li>Paste this SQL into the box
<li>Click go! (this may take a while)
</ul>
</p>

<h2>How it works:</h2>
<p>
<ul>
<li>Step 1. Parse the SQL, the parser isn't really a parser, it does the minimal amount necessary.
This step outputs some JSON that can be interpreted by jquery.flydom-3.1.1.js
<li>Step 2. Take the JSON and makes the HTML elements that show the tables.
<li>Step 3. Iterates over the DIVs in the page and uses the rel attribute to draw an arrow from a foreign key (LI) to a table (DIV)
</ul>
</p>

<h2>Why:</h2>
<p>
Jumbling all 3 steps into one would be slightly more efficient for the PC. Who cares about the PC? lolz
</p>
<p>
The 3 steps are 3 processes, it would be simple to remove the last process and drop it into a mindmap application, or a flowchart app.
</p>

<h2>How does it find a foreign key?</h2>
<p>
http://www.ss64.com/ora/syntax-naming.html
<br>
I name my foreign keys fk_table_name this links to the primary key which I always call id. Some people use table_name_fk
which also works.
</p>
<p>
I name a table of clients 'clients', but a table that has a foreign key to the clients
table is fk_client (we are linking to a single client), note the missing s. There is a little
hack in the code to take this pluraliztion into account.
</p>
<p>
Another problem that I have in my tables it that I have a foreign key with a name that has no
relation to the table name. For example I have a projects table that has a manager (fk_manager), a sales
manager (fk_sales_manager) and a project owner (fk_staff). These are all members of staff, so they all link to the staff table.
You can mark these columns to link to the staff table by adding this text to the columns COMMENT attribute:
<ul>
<li>dbd:fk-to:<b>table name</b>
</ul>
This is easy to do:
<ul>
<li>in SQLyog - right click on the table, alter table, then add the text into the COMMENT section.
<li>in phpMyAdmin - select table, structure, change, add the text into the COMMENT section.
</ul>

</p>
<h2>Hacking the code: How to bend it to your will.</h2>
<p>
The SQL is parsed using regex and pattern matching. It is all very simple. To add more foreign key matching patterns take a look
at column->find_foreign_key()
</p>
<p>
The x, y locations of the tables are stored in your localStorage (HTML5) in your browser. They are
saved as databaseName-tableName so the app will remember the locations of your tables for any number of different
SQL dump scripts. I used localStorage because:
<ul>
<li>It is cool, quick and useful.
<li>We need to save these locations somewhere.
<li>It is local to your machine. As much as I love you dearly, I don't want my server filled with your meaningless x, y table locations.
<li>It is local to your machine. As much as you love me dearly, you don't trust me with your super secret
database name, table names and x, y locations. Good God man! I suggest that you save a copy of the app locally
on your machine, then pull the ethernet cable out of the back of the machine just to make sure. You sexy paranoid fox!
</ul>
</p>
<h2>Hacking the code: The to do list</h2>
<p>
<ul>
<li>Save the database (or SQL) and version ID in the localStorage, allow the user to select which database to view.
<li>Draw different connectors.
<li>Mouse over an arrow and a little icon appears. Click on the icon to change add/remove a right angle.
<li>Add some spring algorithm for best layout.
<li>Add an icon in the table title to hide/show non foreign key columns.
<li>Add an icon in the table title to roll up the table
<li>[1] Add an area on the page where you can trag a table and it will be removed from the diagram. This can be
used to show parts of a database (e.g. arrange the tables to only show 'customers', 'orders', and 'sales staff')
<li>Add a save feature that allows you to save a partial diagram (see [1])
<li>Add a save to file/text stream feature.
</ul>
</p>

</div>
</body>
</html>